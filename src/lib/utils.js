var stringOrChar=/("(?:[^\\"]|\\.)*")|[:,]/g,jsonStringifyPrettyCompact=function(e,t){var n,o,r;return t=t||{},n=JSON.stringify([1],void 0,void 0===t.indent?2:t.indent).slice(2,-3),o=""===n?1/0:void 0===t.maxLength?80:t.maxLength,r=t.replacer,function e(t,a,i){var s,c,u,f,l,d,m,g,p,h,x,_;if(t&&"function"==typeof t.toJSON&&(t=t.toJSON()),void 0===(x=JSON.stringify(t,r)))return x;if(m=o-a.length-i,x.length<=m&&(p=x.replace(stringOrChar,(function(e,t){return t||e+" "}))).length<=m)return p;if(null!=r&&(t=JSON.parse(x),r=void 0),"object"==typeof t&&null!==t){if(g=a+n,u=[],c=0,Array.isArray(t))for(h="[",s="]",m=t.length;c<m;c++)u.push(e(t[c],g,c===m-1?0:1)||"null");else for(h="{",s="}",m=(d=Object.keys(t)).length;c<m;c++)f=d[c],l=JSON.stringify(f)+": ",void 0!==(_=e(t[f],g,l.length+(c===m-1?0:1)))&&u.push(l+_);if(u.length>0)return[h,n+u.join(",\n"+g),s].join("\n"+a)}return x}(e,"",0)},commonjsGlobal="undefined"!=typeof globalThis?globalThis:"undefined"!=typeof window?window:"undefined"!=typeof global?global:"undefined"!=typeof self?self:{};function createCommonjsModule(e,t){return e(t={exports:{}},t.exports),t.exports}function getCjsExportFromNamespace(e){return e&&e.default||e}async function messageWithResult(e,t=null,n=self,o=[]){return new Promise(((r,a)=>{let i;t&&(i=setTimeout((()=>{a(Error(`message timeout: ${e}`))}),t));const s=new MessageChannel;s.port1.onmessage=e=>{clearTimeout(i),r(e.data)},n.postMessage(e,[s.port2,...o])}))}function deepMap(e,t){if(e instanceof Object)for(const[n,o]of Object.entries(e))e[n]=deepMap(o,t);return t(e)}function serialize(e){return jsonStringifyPrettyCompact(e,{replacer:function(e,t){return t instanceof Error?{type:"__ERROR__",message:t.message,stack:t.stack}:t instanceof Function?{type:"__FUNCTION__",name:t.name}:t instanceof Map?{type:"__MAP__",data:[...t]}:t instanceof Set?{type:"__SET__",data:[...t]}:t instanceof Date||"string"==typeof t&&/^\d{4}-[01]\d-[0-3]\dT[012]\d:[0-5]\d:[0-5]\d\.\d{3}Z$/.test(t)?{type:"__DATE__",timestamp:+new Date(t)}:t instanceof Uint8Array?{type:"__Uint8Array__",data:Array.from(t)}:void 0===t?"__UNDEFINED__":t===Number.POSITIVE_INFINITY?"__+INFINITY__":t===Number.NEGATIVE_INFINITY?"__-INFINITY__":Number.isNaN(t)?"__NAN__":t}})}function deserialize(e){try{return deepMap(JSON.parse(e,(function(e,t){if(t instanceof Object){if("__ERROR__"===t.type){const e=Error(t.message);return e.stack=t.stack,e}if("__FUNCTION__"===t.type){const n=self[t.name];return n instanceof Function?n:void console.warn(`Skipped ${e}: Only global functions can be deserialized!`)}if("__MAP__"===t.type)return new Map(t.data);if("__SET__"===t.type)return new Set(t.data);if("__DATE__"===t.type)return new Date(t.timestamp);if("__Uint8Array__"===t.type)return new Uint8Array(t.data)}return"__+INFINITY__"===t?Number.POSITIVE_INFINITY:"__-INFINITY__"===t?Number.NEGATIVE_INFINITY:"__NAN__"===t?NaN:t})),(e=>{if("__UNDEFINED__"!==e)return e}))}catch(e){console.error(e)}}var alea=createCommonjsModule((function(e){!function(e,t,n){function o(e){var t,n=this,o=(t=4022871197,function(e){e=String(e);for(var n=0;n<e.length;n++){var o=.02519603282416938*(t+=e.charCodeAt(n));o-=t=o>>>0,t=(o*=t)>>>0,t+=4294967296*(o-=t)}return 2.3283064365386963e-10*(t>>>0)});n.next=function(){var e=2091639*n.s0+2.3283064365386963e-10*n.c;return n.s0=n.s1,n.s1=n.s2,n.s2=e-(n.c=0|e)},n.c=1,n.s0=o(" "),n.s1=o(" "),n.s2=o(" "),n.s0-=o(e),n.s0<0&&(n.s0+=1),n.s1-=o(e),n.s1<0&&(n.s1+=1),n.s2-=o(e),n.s2<0&&(n.s2+=1),o=null}function r(e,t){return t.c=e.c,t.s0=e.s0,t.s1=e.s1,t.s2=e.s2,t}function a(e,t){var n=new o(e),a=t&&t.state,i=n.next;return i.int32=function(){return 4294967296*n.next()|0},i.double=function(){return i()+11102230246251565e-32*(2097152*i()|0)},i.quick=i,a&&("object"==typeof a&&r(a,n),i.state=function(){return r(n,{})}),i}t&&t.exports?t.exports=a:n&&n.amd?n((function(){return a})):this.alea=a}(0,e,!1)})),xor128=createCommonjsModule((function(e){!function(e,t,n){function o(e){var t=this,n="";t.x=0,t.y=0,t.z=0,t.w=0,t.next=function(){var e=t.x^t.x<<11;return t.x=t.y,t.y=t.z,t.z=t.w,t.w^=t.w>>>19^e^e>>>8},e===(0|e)?t.x=e:n+=e;for(var o=0;o<n.length+64;o++)t.x^=0|n.charCodeAt(o),t.next()}function r(e,t){return t.x=e.x,t.y=e.y,t.z=e.z,t.w=e.w,t}function a(e,t){var n=new o(e),a=t&&t.state,i=function(){return(n.next()>>>0)/4294967296};return i.double=function(){do{var e=((n.next()>>>11)+(n.next()>>>0)/4294967296)/(1<<21)}while(0===e);return e},i.int32=n.next,i.quick=i,a&&("object"==typeof a&&r(a,n),i.state=function(){return r(n,{})}),i}t&&t.exports?t.exports=a:n&&n.amd?n((function(){return a})):this.xor128=a}(0,e,!1)})),xorwow=createCommonjsModule((function(e){!function(e,t,n){function o(e){var t=this,n="";t.next=function(){var e=t.x^t.x>>>2;return t.x=t.y,t.y=t.z,t.z=t.w,t.w=t.v,(t.d=t.d+362437|0)+(t.v=t.v^t.v<<4^e^e<<1)|0},t.x=0,t.y=0,t.z=0,t.w=0,t.v=0,e===(0|e)?t.x=e:n+=e;for(var o=0;o<n.length+64;o++)t.x^=0|n.charCodeAt(o),o==n.length&&(t.d=t.x<<10^t.x>>>4),t.next()}function r(e,t){return t.x=e.x,t.y=e.y,t.z=e.z,t.w=e.w,t.v=e.v,t.d=e.d,t}function a(e,t){var n=new o(e),a=t&&t.state,i=function(){return(n.next()>>>0)/4294967296};return i.double=function(){do{var e=((n.next()>>>11)+(n.next()>>>0)/4294967296)/(1<<21)}while(0===e);return e},i.int32=n.next,i.quick=i,a&&("object"==typeof a&&r(a,n),i.state=function(){return r(n,{})}),i}t&&t.exports?t.exports=a:n&&n.amd?n((function(){return a})):this.xorwow=a}(0,e,!1)})),xorshift7=createCommonjsModule((function(e){!function(e,t,n){function o(e){var t=this;t.next=function(){var e,n,o=t.x,r=t.i;return e=o[r],n=(e^=e>>>7)^e<<24,n^=(e=o[r+1&7])^e>>>10,n^=(e=o[r+3&7])^e>>>3,n^=(e=o[r+4&7])^e<<7,e=o[r+7&7],n^=(e^=e<<13)^e<<9,o[r]=n,t.i=r+1&7,n},function(e,t){var n,o=[];if(t===(0|t))o[0]=t;else for(t=""+t,n=0;n<t.length;++n)o[7&n]=o[7&n]<<15^t.charCodeAt(n)+o[n+1&7]<<13;for(;o.length<8;)o.push(0);for(n=0;n<8&&0===o[n];++n);for(8==n&&(o[7]=-1),e.x=o,e.i=0,n=256;n>0;--n)e.next()}(t,e)}function r(e,t){return t.x=e.x.slice(),t.i=e.i,t}function a(e,t){null==e&&(e=+new Date);var n=new o(e),a=t&&t.state,i=function(){return(n.next()>>>0)/4294967296};return i.double=function(){do{var e=((n.next()>>>11)+(n.next()>>>0)/4294967296)/(1<<21)}while(0===e);return e},i.int32=n.next,i.quick=i,a&&(a.x&&r(a,n),i.state=function(){return r(n,{})}),i}t&&t.exports?t.exports=a:n&&n.amd?n((function(){return a})):this.xorshift7=a}(0,e,!1)})),xor4096=createCommonjsModule((function(e){!function(e,t,n){function o(e){var t=this;t.next=function(){var e,n,o=t.w,r=t.X,a=t.i;return t.w=o=o+1640531527|0,n=r[a+34&127],e=r[a=a+1&127],n^=n<<13,e^=e<<17,n^=n>>>15,e^=e>>>12,n=r[a]=n^e,t.i=a,n+(o^o>>>16)|0},function(e,t){var n,o,r,a,i,s=[],c=128;for(t===(0|t)?(o=t,t=null):(t+="\0",o=0,c=Math.max(c,t.length)),r=0,a=-32;a<c;++a)t&&(o^=t.charCodeAt((a+32)%t.length)),0===a&&(i=o),o^=o<<10,o^=o>>>15,o^=o<<4,o^=o>>>13,a>=0&&(i=i+1640531527|0,r=0==(n=s[127&a]^=o+i)?r+1:0);for(r>=128&&(s[127&(t&&t.length||0)]=-1),r=127,a=512;a>0;--a)o=s[r+34&127],n=s[r=r+1&127],o^=o<<13,n^=n<<17,o^=o>>>15,n^=n>>>12,s[r]=o^n;e.w=i,e.X=s,e.i=r}(t,e)}function r(e,t){return t.i=e.i,t.w=e.w,t.X=e.X.slice(),t}function a(e,t){null==e&&(e=+new Date);var n=new o(e),a=t&&t.state,i=function(){return(n.next()>>>0)/4294967296};return i.double=function(){do{var e=((n.next()>>>11)+(n.next()>>>0)/4294967296)/(1<<21)}while(0===e);return e},i.int32=n.next,i.quick=i,a&&(a.X&&r(a,n),i.state=function(){return r(n,{})}),i}t&&t.exports?t.exports=a:n&&n.amd?n((function(){return a})):this.xor4096=a}(0,e,!1)})),tychei=createCommonjsModule((function(e){!function(e,t,n){function o(e){var t=this,n="";t.next=function(){var e=t.b,n=t.c,o=t.d,r=t.a;return e=e<<25^e>>>7^n,n=n-o|0,o=o<<24^o>>>8^r,r=r-e|0,t.b=e=e<<20^e>>>12^n,t.c=n=n-o|0,t.d=o<<16^n>>>16^r,t.a=r-e|0},t.a=0,t.b=0,t.c=-1640531527,t.d=1367130551,e===Math.floor(e)?(t.a=e/4294967296|0,t.b=0|e):n+=e;for(var o=0;o<n.length+20;o++)t.b^=0|n.charCodeAt(o),t.next()}function r(e,t){return t.a=e.a,t.b=e.b,t.c=e.c,t.d=e.d,t}function a(e,t){var n=new o(e),a=t&&t.state,i=function(){return(n.next()>>>0)/4294967296};return i.double=function(){do{var e=((n.next()>>>11)+(n.next()>>>0)/4294967296)/(1<<21)}while(0===e);return e},i.int32=n.next,i.quick=i,a&&("object"==typeof a&&r(a,n),i.state=function(){return r(n,{})}),i}t&&t.exports?t.exports=a:n&&n.amd?n((function(){return a})):this.tychei=a}(0,e,!1)})),_nodeResolve_empty={},_nodeResolve_empty$1=Object.freeze({__proto__:null,default:_nodeResolve_empty}),require$$0=getCjsExportFromNamespace(_nodeResolve_empty$1),seedrandom$1=createCommonjsModule((function(e){!function(t,n,o){var r,a=256,i=o.pow(a,6),s=o.pow(2,52),c=2*s,u=255;function f(e,u,f){var h=[],x=g(m((u=1==u?{entropy:!0}:u||{}).entropy?[e,p(n)]:null==e?function(){try{var e;return r&&(e=r.randomBytes)?e=e(a):(e=new Uint8Array(a),(t.crypto||t.msCrypto).getRandomValues(e)),p(e)}catch(e){var o=t.navigator,i=o&&o.plugins;return[+new Date,t,i,t.screen,p(n)]}}():e,3),h),_=new l(h),y=function(){for(var e=_.g(6),t=i,n=0;e<s;)e=(e+n)*a,t*=a,n=_.g(1);for(;e>=c;)e/=2,t/=2,n>>>=1;return(e+n)/t};return y.int32=function(){return 0|_.g(4)},y.quick=function(){return _.g(4)/4294967296},y.double=y,g(p(_.S),n),(u.pass||f||function(e,t,n,r){return r&&(r.S&&d(r,_),e.state=function(){return d(_,{})}),n?(o.random=e,t):e})(y,x,"global"in u?u.global:this==o,u.state)}function l(e){var t,n=e.length,o=this,r=0,i=o.i=o.j=0,s=o.S=[];for(n||(e=[n++]);r<a;)s[r]=r++;for(r=0;r<a;r++)s[r]=s[i=u&i+e[r%n]+(t=s[r])],s[i]=t;(o.g=function(e){for(var t,n=0,r=o.i,i=o.j,s=o.S;e--;)t=s[r=u&r+1],n=n*a+s[u&(s[r]=s[i=u&i+t])+(s[i]=t)];return o.i=r,o.j=i,n})(a)}function d(e,t){return t.i=e.i,t.j=e.j,t.S=e.S.slice(),t}function m(e,t){var n,o=[],r=typeof e;if(t&&"object"==r)for(n in e)try{o.push(m(e[n],t-1))}catch(e){}return o.length?o:"string"==r?e:e+"\0"}function g(e,t){for(var n,o=e+"",r=0;r<o.length;)t[u&r]=u&(n^=19*t[u&r])+o.charCodeAt(r++);return p(t)}function p(e){return String.fromCharCode.apply(0,e)}if(g(o.random(),n),e.exports){e.exports=f;try{r=require$$0}catch(e){}}else o.seedrandom=f}("undefined"!=typeof self?self:commonjsGlobal,[],Math)}));seedrandom$1.alea=alea,seedrandom$1.xor128=xor128,seedrandom$1.xorwow=xorwow,seedrandom$1.xorshift7=xorshift7,seedrandom$1.xor4096=xor4096,seedrandom$1.tychei=tychei;var seedrandom=seedrandom$1;function seedRandom(e){return seedrandom(e)}async function includeUrl(url,context={},parse=(e=>e)){const body=await fetch(url),content=parse(await body.text());function evalInContext(){eval(`${content}`)}return evalInContext.call(context),context}async function storeJson(e,t){const n=(e=fixPath(e,".json")).match(/^\/(project|global)\/(.+$)/);if(n){const e=serialize(t),o={type:"store",projectId:"global"===n[1]?0:void 0,fileName:n[2],data:e};await messageWithResult(o,1e3,self.__messagePort).catch((()=>{throw Error(`could not store file ${n[2]}`)}))}}async function loadJson(e){e=fixPath(e,".json");return deserialize(await getFileContent(e))}async function getFileContent(e){e=fixPath(e);const t=await fetch(e);if(200!==t.status)throw Error(`could not open file '${e}'`);return await t.text()}function fixPath(e,t=""){return/^\//.test(e)||(e="/"+e),/^\/(project|global)\//.test(e)||(e="/project"+e),e.endsWith(t)||(e+=t),e}let localStorageCache;async function initLocalStorage(){try{localStorageCache=new Map(await loadJson("localstorage"))}catch(e){localStorageCache=new Map}}function saveLocalStorage(){storeJson("localstorage",localStorageCache)}const localStorage={get length(){return localStorageCache.size},key:e=>e<0||e>=localStorageCache.size?null:Array.from(localStorageCache.keys())[e],setItem(e,t){localStorageCache.set(e,t),saveLocalStorage()},getItem:e=>localStorageCache.has(e)?localStorageCache.get(e):null,removeItem(e){localStorageCache.delete(e)&&saveLocalStorage()},clear(){localStorageCache.clear(),saveLocalStorage()}};function getCanvas(e=0){if(0!==e)throw Error("multiple canvases were removed");return self.__canvas}async function sleep(e){return new Promise(((t,n)=>{setTimeout(t,e)}))}async function setMessages(e){throw Error("setMessages was removed")}async function addMessage(e){throw Error("addMessage was removed")}let images=new Map;async function loadImages(e){const t=await Promise.all(e.map((async e=>{const t=(e=fixPath(e)).match(/\/([^\/]+)\.(png|jpeg)$/);let n=e;t&&t.length>1&&(n=t[1]);return{name:n,bitmap:await createImageBitmap(await fetch(e).then((e=>e.blob())))}})));for(const e of t)images.set(e.name,e.bitmap)}function getImage(e){return images.get(e)}function onVideoFrameUpdate(e){self.__onVideoFrameUpdate=e}function onMouseDown(e){self.onmousedown=e}function onMouseMove(e){self.onmousemove=e}function onMouseUp(e){self.onmouseup=e}export{addMessage,fixPath,getCanvas,getFileContent,getImage,includeUrl,initLocalStorage,loadImages,loadJson,localStorage,onMouseDown,onMouseMove,onMouseUp,onVideoFrameUpdate,seedRandom,setMessages,sleep,storeJson};
