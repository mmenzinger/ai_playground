var t="object"==typeof global&&global&&global.Object===Object&&global,e="object"==typeof self&&self&&self.Object===Object&&self,n=t||e||Function("return this")(),o=n.Symbol,r=Object.prototype,s=r.hasOwnProperty,i=r.toString,a=o?o.toStringTag:void 0;var u=Object.prototype.toString;var l=o?o.toStringTag:void 0;function c(t){return null==t?void 0===t?"[object Undefined]":"[object Null]":l&&l in Object(t)?function(t){var e=s.call(t,a),n=t[a];try{t[a]=void 0;var o=!0}catch(t){}var r=i.call(t);return o&&(e?t[a]=n:delete t[a]),r}(t):function(t){return u.call(t)}(t)}var f=/\s/;var p=/^\s+/;function m(t){return t?t.slice(0,function(t){for(var e=t.length;e--&&f.test(t.charAt(e)););return e}(t)+1).replace(p,""):t}function g(t){var e=typeof t;return null!=t&&("object"==e||"function"==e)}var d=/^[-+]0x[0-9a-f]+$/i,v=/^0b[01]+$/i,h=/^0o[0-7]+$/i,w=parseInt;function y(t){if("number"==typeof t)return t;if(function(t){return"symbol"==typeof t||function(t){return null!=t&&"object"==typeof t}(t)&&"[object Symbol]"==c(t)}(t))return NaN;if(g(t)){var e="function"==typeof t.valueOf?t.valueOf():t;t=g(e)?e+"":e}if("string"!=typeof t)return 0===t?t:+t;t=m(t);var n=v.test(t);return n||h.test(t)?w(t.slice(2),n?2:8):d.test(t)?NaN:+t}var b=function(){return n.Date.now()},M=Math.max,k=Math.min;function j(t,e,n){var o,r,s,i,a,u,l=0,c=!1,f=!1,p=!0;if("function"!=typeof t)throw new TypeError("Expected a function");function m(e){var n=o,s=r;return o=r=void 0,l=e,i=t.apply(s,n)}function d(t){return l=t,a=setTimeout(h,e),c?m(t):i}function v(t){var n=t-u;return void 0===u||n>=e||n<0||f&&t-l>=s}function h(){var t=b();if(v(t))return w(t);a=setTimeout(h,function(t){var n=e-(t-u);return f?k(n,s-(t-l)):n}(t))}function w(t){return a=void 0,p&&o?m(t):(o=r=void 0,i)}function j(){var t=b(),n=v(t);if(o=arguments,r=this,u=t,n){if(void 0===a)return d(u);if(f)return clearTimeout(a),a=setTimeout(h,e),m(u)}return void 0===a&&(a=setTimeout(h,e)),i}return e=y(e)||0,g(n)&&(c=!!n.leading,s=(f="maxWait"in n)?M(y(n.maxWait)||0,e):s,p="trailing"in n?!!n.trailing:p),j.cancel=function(){void 0!==a&&clearTimeout(a),l=0,o=u=r=a=void 0},j.flush=function(){return void 0===a?i:w(b())},j}class T{#worker=null;#messagePortWorker=null;#workerHandler={log:t=>{window.__port?.postMessage(t.data)},store:t=>{(async function(t,e=null,n=self,o=[]){return new Promise(((r,s)=>{let i;e&&(i=setTimeout((()=>{s(Error(`message timeout: ${t}`))}),e));const a=new MessageChannel;a.port1.onmessage=t=>{clearTimeout(i),r(t.data)},n.postMessage(t,[a.port2,...o])}))})(t.data,1e3,window.__port).then((()=>{t.ports[0].postMessage(!0)}))}};#settings={onmousedown:!1,onmouseup:!1,onmousemove:!1};constructor(t){this.#settings={...this.#settings,...t}}async start(t){return new Promise(((e,n)=>{const o=document.createElement("canvas");t.innerHTML="",t.appendChild(o),o.width=t.offsetWidth,o.height=t.offsetHeight;const r=o.transferControlToOffscreen();this.#settings.onmousedown&&(o.onmousedown=t=>this.#sendMouseEvent(t,o,"onmousedown")),this.#settings.onmouseup&&(o.onmouseup=t=>this.#sendMouseEvent(t,o,"onmouseup")),this.#settings.onmousemove&&(o.onmousemove=function(t,e,n){var o=!0,r=!0;if("function"!=typeof t)throw new TypeError("Expected a function");return g(n)&&(o="leading"in n?!!n.leading:o,r="trailing"in n?!!n.trailing:r),j(t,e,{leading:o,maxWait:e,trailing:r})}((t=>this.#sendMouseEvent(t,o,"onmousemove")),100)),this.#worker&&this.#worker.terminate();const s=new MessageChannel;this.#worker=new Worker("/simulator/scenario-worker.js",{type:"module"}),s.port1.onmessage=t=>{"ready"===t.data.type&&(this.#messagePortWorker=t.ports[0],t.ports[0].onmessage=t=>{const e=t.data.type;this.#workerHandler[e]&&this.#workerHandler[e](t)},e())},this.#worker.postMessage({type:"setup",canvas:r},[s.port2,r]),window.__port?.postMessage({type:"log",logs:[]})}))}async call(t,e,...n){return new Promise(((o,r)=>{const s=new MessageChannel;s.port1.onmessage=t=>{o(t.data)},this.#messagePortWorker?.postMessage({type:"call",file:t,functionName:e,args:n},[s.port2])}))}terminate(){this.#worker?.terminate(),this.#worker=null}#sendMouseEvent(t,e,n){var o=e.getBoundingClientRect(),r=t.clientX-o.left,s=t.clientY-o.top;this.#messagePortWorker?.postMessage({type:n,x:r,y:s,width:o.width,height:o.height,button:t.button,altKey:t.altKey,ctrlKey:t.ctrlKey,timeStamp:t.timeStamp})}}export{T as ScenarioWorker};
